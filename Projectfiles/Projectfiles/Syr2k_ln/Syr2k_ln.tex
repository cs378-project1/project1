\chapter{Example: $ C := A B ^ T + B A ^ T + C $ --  \large Team: --}



\section{Operation}

Consider the operation
\[
C := A B ^ T + B A ^ T + C
\]
where $ C $ is a $ m \times m $ lower triangular matrix and $ A $ and $ B $ is a $ m \times m $ matrix.
This is what we call a symmetric rank-2k update
with the {\sc l}ower triangular matrix on the {\sc r}ight.
We will refer to this operation
as {\sc Syr2k\_ln} where the {\sc ln} stands for
\underline{l}ower triangular
\underline{n}o-transpose.

\section{Precondition and postcondition}

In the precondition 
\[
C = \widehat C
\]
$ \widehat C $ denotes the original contents of $ C $.
This allows us to express the state upon completion, the postcondition, as
\[
C := A B ^ T + B A ^ T + \widehat C.
\]
It is implicitly assumed that $ C $ is nonunit lower triangular.
\section{Partitioned Matrix Expressions and loop invariants}

There are two PMEs for this operation.

\subsection{PME 1}

To derive the first PME, partition
\[
C \rightarrow
\left(\begin{array}{c I c}
C_{TL} & * \\ \whline
C_{BL} & C_{BR}
\end{array}\right)
,
	\quad  \quad
A \rightarrow 
\left(\begin{array}{c}
A_T \\ \whline
A_B
\end{array}\right)
,
\quad \mbox{and} \quad
B \rightarrow 
\left(\begin{array}{c I c}
B_T^T & B_B^T
\end{array}\right)
\]
Substituting these into the postcondition
yields
\[
\left(\begin{array}{c I c}
C_{TL} & * \\ \whline
C_{BL} & C_{BR}
\end{array}\right)
=
\left(\begin{array}{c}
A_T \\ \whline
A_B
\end{array}\right)
\left(\begin{array}{c I c}
B_T^T & B_B^T
\end{array}\right)
+
\left(\begin{array}{c}
B_T \\ \whline
B_B
\end{array}\right)
\left(\begin{array}{c I c}
A_T^T & A_B^T
\end{array}\right)
+
\left(\begin{array}{c I c}
C_{TL} & * \\ \whline
C_{BL} & C_{BR}
\end{array}\right)
\]
or, equivalently,
\[
\left(\begin{array}{c I c}
C_{TL} & * \\ \whline
C_{BL} & C_{BR}
\end{array}\right)
=
\left(\begin{array}{c I c}
A_T B_T^T + B_T A_T^T + C_{TL} & * \\ \whline
A_B B_T^T + B_B A_T^T + C_{BL} & A_B B_B^T + B_B A_B^T + C_{BR}
\end{array}\right)
\]
which we refer to as the first PME for this operations.

From this, we can choose five loop invariants:
\begin{description}
	\item
	{\bf Invariant 1:}
	$
	\left(\begin{array}{c I c}
		C_{TL} & * \\ \whline
		C_{BL} & C_{BR}
		\end{array}\right)
	 = 
	 \left(\begin{array}{c I c}
		A_T B_T^T + B_T A_T^T + \widehat C_{TL} & * \\ \whline
		\widehat C_{BL} & \widehat C_{BR}
		\end{array}\right)
	$. \\
	(The top left part has been left alone and the bottom parts have been completely computed).
	\item
	{\bf Invariant 2:}
	$
	\left(\begin{array}{c I c}
		C_{TL} & * \\ \whline
		C_{BL} & C_{BR}
		\end{array}\right)
		 = 
		 \left(\begin{array}{c I c}
			\widehat C_{TL} & * \\ \whline
			\widehat C_{BL} & A_B B_B^T + B_B A_B^T + \widehat C_{BR}
			\end{array}\right)
	$. \\
	(The bottom right part has been left alone and the left parts have been completely computed).
	\item
	{\bf Invariant 3:}
	$
	\left(\begin{array}{c I c}
		C_{TL} & * \\ \whline
		C_{BL} & C_{BR}
		\end{array}\right)
	 = 
	 \left(\begin{array}{c I c}
		A_T B_T^T + B_T A_T^T + \widehat C_{TL} & * \\ \whline
		A_B B_T^T + \widehat C_{BL} & \widehat C_{BR}
		\end{array}\right)
	$. \\
	(The top left part has been left alone, the bottom left part has been partially computed, and the bottom right part has been completely computed).
	\item
	{\bf Invariant 4:}
	$
	\left(\begin{array}{c I c}
		C_{TL} & * \\ \whline
		C_{BL} & C_{BR}
		\end{array}\right) = 
		\left(\begin{array}{c I c}
			A_T B_T^T + B_T A_T^T + \widehat C_{TL} & * \\ \whline
			B_B A_T^T + \widehat C_{BL} & \widehat C_{BR}
			\end{array}\right)
	$. \\
	(The top left part has been left alone, the bottom right part has been partially computed, and the bottom left part has been completely computed).
	\item
	{\bf Invariant 5:}
	$
	\left(\begin{array}{c I c}
		C_{TL} & * \\ \whline
		C_{BL} & C_{BR}
		\end{array}\right) = 
		\left(\begin{array}{c I c}
			\widehat C_{TL} & * \\ \whline
			A_B B_T^T + \widehat C_{BL} & A_B B_B^T + B_B A_B^T + \widehat C_{BR}
			\end{array}\right)
	$. \\
	(The bottom right part has been left alone, the bottom left part has been partially computed, and the top left part has been completely computed).
\end{description}

\subsection{PME 2}

To derive the second PME, partition
\[
	A \rightarrow 
	\left(\begin{array}{c I c}
	A_L & A_R
	\end{array}\right)
	,
	\quad \mbox{and} \quad
	B \rightarrow 
	\left(\begin{array}{c I c}
	B_L & B_R
	\end{array}\right)
\]
and do not partition $ C $.
Substituting these into the postcondition
yields
\[
C
=
\left(\begin{array}{c I c}
A_L & A_R
\end{array}\right)
\left(\begin{array}{c}
B_L^T \\ \whline 
B_R^T
\end{array}\right)
+
\left(\begin{array}{c I c}
B_L & B_R
\end{array}\right)
\left(\begin{array}{c}
A_L^T \\ \whline 
A_R^T
\end{array}\right)
+
C
\]
or, equivalently,
\[
C
=
A_L B_L ^ T + A_R B_R ^ T + B_L A_L ^ T + B_R A_R ^ T + \widehat C
\]
which we refer to as the second PME.

From this, we can choose one more loop invariant:
\begin{description}
	\item
	{\bf Invariant 6:}
	$
	C =
	A_L B_L ^ T + B_L A_L ^ T + \widehat C$.\\
	 (The right part has been completely finished).
\end{description}

\subsection{Notes}

How do I decide to partition the matrices in the postcondition?

\begin{itemize}
	\item
	Pick a matrix (operand), any matrix.  
	\item 
	If that matrix has 
	\begin{itemize}
		\item 
	a triangular structure (in storage), then you want to either partition is into four quadrants, or not at all.  Symmetric matrices and triangular matrices have a triangular structure (in storage).
		\item
	no particular structure, then you partition it vertically (left-right), horizontally (top-bottom), or not at all.
	\end{itemize}
	\item
	Next, partition the other matrices similarly, but conformally (meaning the 
	resulting multiplications with the parts are legal).
\end{itemize}
Take our problem here:  $ B := L B $.
Start by partitioning $ L $ in to quadrants:
\[
B = 
\left(\begin{array}{c I c}
L_{TL} & 0 \\ \whline
L_{BL} & L_{BR}
\end{array}\right)
		\widehat B.
\]
Now, the way partitioned matrix multiplication works, this doesn't make sense:
\[
B = 
\begin{array}[t]{c}
\underbrace{
\left(\begin{array}{c I c}
L_{TL} & 0 \\ \whline
L_{BL} & L_{BR}
\end{array}\right)
		\widehat B.
	}\\
	\left(\begin{array}{c}
	L_{TL} \times \mbox{something} + 0 \times \mbox{something} \\ \whline
	L_{BL} \times \mbox{something} + L_{BR} \times \mbox{something}
	\end{array}\right)
	\end{array}.
\]
So, we need to also partition $ B $ into a top part and a bottom part:
\[
\left(\begin{array}{c}
B_T \\ \whline
B_B
\end{array}\right)
= 
\begin{array}[t]{c}
\underbrace{
	\left(\begin{array}{c I c}
	L_{TL} & 0 \\ \whline
	L_{BL} & L_{BR}
	\end{array}\right)
		\left(\begin{array}{c}
		\widehat B_T \\ \whline
		\widehat B_B
		\end{array}\right).
	}\\
	\left(\begin{array}{c}
	L_{TL} \widehat B_T + 0 \times \widehat B_B\\ \whline
	L_{BL}  \widehat B_T + L_{BR}  \widehat B_B
	\end{array}\right)
	\end{array}
\]

Alternatively, what if you don't partition $ L $?  You have to partition {\em something} so let's try partitioning $ B $:
\[
\left(\begin{array}{c}
B_T \\ \whline
B_B
\end{array}\right)
=
L 
\left(\begin{array}{c}
\widehat B_T \\ \whline
\widehat B_B
\end{array}\right).
\]
But that doesn't work...
Instead
\[
\left(\begin{array}{c I c}
B_L & B_R 
\end{array}\right)
=
L 
\left(\begin{array}{c I c}
\widehat B_L & \widehat B_R 
\end{array}\right)
=
\left(\begin{array}{c I c}
L \widehat B_L & L \widehat B_R 
\end{array}\right)
\]
works just fine.  

\section{Deriving all unblocked algorithms}

The below table summarizes all loop invariants, with links to all files related to this operation.

\noindent The worksheet and code skeletons were genered using 
 the \href{http://edx-org-utaustinx.s3.amazonaws.com/UT1401x/LAFFPfC/Spark/index.html}{\ding{42} Spark webpage}.
 

\begin{center}
	\begin{tabular}{| c | l I c | l |} \hline
		& Invariant & Derivations &Implementations \\ \whline
		1 & 
		$
		\left(\begin{array}{c}
		B_T \\ \whline
		B_B
		\end{array}\right) = 
		\left(\begin{array}{c}
		\widehat B_T \\ \whline
		L_{BR} \widehat B_B
		\end{array}\right)
		$
		&
		\href{trmm_llnn/Derivations/trmm_llnn_unb_var1.pdf}
		{PDF}
		&
		\begin{minipage}{0.3\textwidth}
		\href{trmm_llnn/flameatlab/trmm_llnn_unb_var1.mlx}
		{trmm\_llnn\_unb\_var1.mlx}\\
		\href{trmm_llnn/FLAMEC/trmm_llnn_unb_var1.c}
		{trmm\_llnn\_unb\_var1.c}
	    \end{minipage}
	    \\ \hline
	    2 & 
	    $
	    \left(\begin{array}{c}
	    B_T \\ \whline
	    B_B
	    \end{array}\right) = 
	    \left(\begin{array}{c}
	    \widehat B_T \\ \whline
	    L_{BL} B_T + L_{BR} \widehat B_B
	    \end{array}\right)
	    $
	    &
	    \href{trmm_llnn/Derivations/trmm_llnn_unb_var2.pdf}
	    {PDF}
	    &
	    \begin{minipage}{0.3\textwidth}
	    	\href{trmm_llnn/flameatlab/trmm_llnn_unb_var2.mlx}
	    	{trmm\_llnn\_unb\_var2.mlx}\\
	    	\href{trmm_llnn/FLAMEC/trmm_llnn_unb_var2.c}
	    	{trmm\_llnn\_unb\_var2.c}
	    \end{minipage}
	    \\ \hline
	    3 & 
	    $
	    \left( \begin{array}{c I c}
	    B_L & B_R
	    \end{array}\right) = 
	    \left( \begin{array}{c I c}
	    L \widehat B_L & \widehat B_R
	    \end{array}\right)
	    $
	    &
	    \href{trmm_llnn/Derivations/trmm_llnn_unb_var3.pdf}
	    {PDF}
	    &
	    \begin{minipage}{0.3\textwidth}
	    	\href{trmm_llnn/flameatlab/trmm_llnn_unb_var3.mlx}
	    	{trmm\_llnn\_unb\_var3.mlx}\\
	    	\href{trmm_llnn/FLAMEC/trmm_llnn_unb_var3.c}
	    	{trmm\_llnn\_unb\_var3.c}
	    \end{minipage}
	    \\ \hline
	    4 & 
	    $
	    \left( \begin{array}{c I c}
	    B_L & B_R
	    \end{array}\right) = 
	    \left( \begin{array}{c I c}
	    \widehat B_L & L \widehat B_R
	    \end{array}\right)
	    $
	    &
	    \href{trmm_llnn/Derivations/trmm_llnn_unb_var4.pdf}
	    {PDF}
	    &
	    \begin{minipage}{0.3\textwidth}
	    	\href{trmm_llnn/flameatlab/trmm_llnn_unb_var4.mlx}
	    	{trmm\_llnn\_unb\_var4.mlx}\\
	    	\href{trmm_llnn/FLAMEC/trmm_llnn_unb_var4.c}
	    	{trmm\_llnn\_unb\_var4.c}
	    \end{minipage}
	    \\ \hline
	\end{tabular}
\end{center}

\section{Deriving all blocked algorithms}

The below table summarizes all loop invariants, with links to all files related to this operation.

\noindent The worksheet and code skeletons were genered using 
the \href{http://edx-org-utaustinx.s3.amazonaws.com/UT1401x/LAFFPfC/Spark/index.html}{\ding{42} Spark webpage}.


\begin{center}
	\begin{tabular}{| c | l I c | l |} \hline
		& Invariant & Derivations &Implementations \\ \whline
		1 & 
		$
		\left(\begin{array}{c}
		B_T \\ \whline
		B_B
		\end{array}\right) = 
		\left(\begin{array}{c}
		\widehat B_T \\ \whline
		L_{BR} \widehat B_B
		\end{array}\right)
		$
		&
		\href{trmm_llnn/Derivations/trmm_llnn_blk_var1.pdf}
		{PDF}
		&
		\begin{minipage}{0.3\textwidth}
			\href{trmm_llnn/flameatlab/trmm_llnn_blk_var1.mlx}
			{trmm\_llnn\_blk\_var1.mlx}\\
			\href{trmm_llnn/FLAMEC/trmm_llnn_blk_var1.c}
			{trmm\_llnn\_blk\_var1.c}
		\end{minipage}
		\\ \hline
		2 & 
		$
		\left(\begin{array}{c}
		B_T \\ \whline
		B_B
		\end{array}\right) = 
		\left(\begin{array}{c}
		\widehat B_T \\ \whline
		L_{BL} B_T + L_{BR} \widehat B_B
		\end{array}\right)
		$
		&
		\href{trmm_llnn/Derivations/trmm_llnn_blk_var2.pdf}
		{PDF}
		&
		\begin{minipage}{0.3\textwidth}
			\href{trmm_llnn/flameatlab/trmm_llnn_blk_var2.mlx}
			{trmm\_llnn\_blk\_var2.mlx}\\
			\href{trmm_llnn/FLAMEC/trmm_llnn_blk_var2.c}
			{trmm\_llnn\_blk\_var2.c}
		\end{minipage}
		\\ \hline
		3 & 
		$
		\left( \begin{array}{c I c}
		B_L & B_R
		\end{array}\right) = 
		\left( \begin{array}{c I c}
		L \widehat B_L & \widehat B_R
		\end{array}\right)
		$
		&
		\href{trmm_llnn/Derivations/trmm_llnn_blk_var3.pdf}
		{PDF}
		&
		\begin{minipage}{0.3\textwidth}
			\href{trmm_llnn/flameatlab/trmm_llnn_blk_var3.mlx}
			{trmm\_llnn\_blk\_var3.mlx}\\
			\href{trmm_llnn/FLAMEC/trmm_llnn_blk_var3.c}
			{trmm\_llnn\_blk\_var3.c}
		\end{minipage}
		\\ \hline
		4 & 
		$
		\left( \begin{array}{c I c}
		B_L & B_R
		\end{array}\right) = 
		\left( \begin{array}{c I c}
		\widehat B_L & L \widehat B_R
		\end{array}\right)
		$
		&
		\href{trmm_llnn/Derivations/trmm_llnn_blk_var4.pdf}
		{PDF}
		&
		\begin{minipage}{0.3\textwidth}
			\href{trmm_llnn/flameatlab/trmm_llnn_blk_var4.mlx}
			{trmm\_llnn\_blk\_var4.mlx}\\
			\href{trmm_llnn/FLAMEC/trmm_llnn_blk_var4.c}
			{trmm\_llnn\_blk\_var4.c}
		\end{minipage}
		\\ \hline
	\end{tabular}
\end{center}
